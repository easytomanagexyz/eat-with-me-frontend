generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_TENANT")
}

model Customer {
  id            String   @id @default(uuid())
  name          String
  phone         String
  email         String?
  notes         String?
  joinDate      DateTime @default(now())
  loyaltyPoints Int      @default(0)
  totalSpent    Float    @default(0)
  totalOrders   Int      @default(0)
  visitCount    Int      @default(0)
  lastVisit     DateTime?
  loyaltyTier   String   @default("bronze")
  status        String   @default("active")
  whatsappOptIn Boolean  @default(false)
  birthDate     DateTime?
  anniversary   DateTime?
  preferences   String[] @default([])
  referralCode  String?  @unique
  referredBy    String?
  referralCount Int      @default(0)
  updatedAt     DateTime @updatedAt
  orders        Order[]  @relation("CustomerOrders")
  loyaltyLogs   LoyaltyLog[]
}

model Staff {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String   // <<< FIX: Added the missing password field
  phone     String
  pin       String
  isActive  Boolean  @default(true)
  salary    Float?
  permissions String[] @default([])
  dashboardModules String[] @default([])
  joinDate  DateTime? @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  shiftLogs      ShiftLog[]
  salaryPayments SalaryPayment[]
  waiterOrders   Order[] @relation("OrderWaiters")
  createdOrders  Order[] @relation("OrderCreatedBy")
}

model Restaurant {
  id                  String   @id // <<< FIX: Removed @default(uuid()) to allow manual ID assignment
  name                String
  address             String?
  phone               String?
  email               String?
  taxNumber           String?
  fssaiNumber         String?
  currencySymbol      String?
  currency            String?  @default("INR")
  country             String?
  language            String?  @default("English")
  plan                String?
  theme               String?  @default("light")
  notifications       Boolean  @default(true)
  autoBackup          Boolean  @default(false)
  whatsappApiKey      String?
  whatsappPhoneNumber String?
  enableMarketing     Boolean  @default(false)
  taxRules            Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model MenuItem {
  id          String      @id @default(cuid())
  name        String
  price       Float
  description String?
  available   Boolean     @default(true)
  isVeg       Boolean     @default(false)
  spiceLevel  Int?
  cookingTime Int?
  isPopular   Boolean     @default(false)
  allergens   String[]
  calories    Int?
  protein     Int?
  carbs       Int?
  fat         Int?

  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])

  orderItems  OrderItem[] // Added back-relation to OrderItem
  recipes     Recipe[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LoyaltyReward {
  id               String   @id @default(cuid())
  title            String
  description      String
  pointsRequired   Int
  type             String
  value            Float
  validUntil       DateTime?
  maxRedemptions   Int?
  currentRedemptions Int    @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model LoyaltyRule {
  id             String   @id @default(cuid())
  name           String
  type           String
  condition      String
  pointsPerRupee Float?
  bonusPoints    Int?
  minOrderValue  Float?
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Order {
  id                 String        @id @default(uuid())
  orderNumber        String        @unique
  orderSource        String        @default("POS")
  status             String        @default("NEW")
  priority           String        @default("NORMAL")
  deliveryType       String        @default("DINE_IN")
  subtotal           Float         @default(0)
  taxAmount          Float         @default(0)
  discount           Float         @default(0)
  totalAmount        Float         @default(0)
  paymentMethod      String        @default("cash")
  paymentStatus      String        @default("paid")
  paymentBreakdown   Json?
  taxes              Json?
  tipAmount          Float         @default(0)
  guests             Int           @default(0)
  specialInstructions String?
  deliveryAddress    String?
  metadata           Json?
  orderTime          DateTime      @default(now())
  estimatedTime      DateTime?
  actualCookingTime  Int?
  completedAt        DateTime?
  rating             Int?
  feedback           String?

  tableId            String?
  table              Table?        @relation(fields: [tableId], references: [id])

  customerId         String?
  customer           Customer?     @relation("CustomerOrders", fields: [customerId], references: [id])

  waiterId           String?
  waiter             Staff?        @relation("OrderWaiters", fields: [waiterId], references: [id])

  createdById        String?
  createdBy          Staff?        @relation("OrderCreatedBy", fields: [createdById], references: [id])

  items              OrderItem[]
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  menuItemId  String?
  menuItem    MenuItem? @relation(fields: [menuItemId], references: [id])
  name        String
  category    String?
  quantity    Int      @default(1)
  price       Float    @default(0)
  notes       String?
  modifiers   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Table {
  id             String   @id @default(uuid())
  number         Int
  name           String?
  area           String?
  status         String   @default("FREE")
  capacity       Int      @default(4)
  guests         Int      @default(0)
  currentOrderId String?
  currentBillId  String?
  lastOrderAt    DateTime?
  notes          String?

  orders         Order[]
}

model Reservation {
  id              String   @id @default(uuid())
  tableId         String?
  customerId      String?
  date            DateTime
  time            String
  partySize       Int
  status          String
  customerName    String
  customerPhone   String
  customerEmail   String?
  specialRequests String?
  occasion        String?
  source          String?
  priority        String?
}

model InventoryItem {
  id           String    @id @default(cuid())
  name         String
  category     String
  unit         String
  currentStock Float     @default(0)
  minStock     Float     @default(0)
  maxStock     Float     @default(0)
  costPerUnit  Float     @default(0)
  supplierId   String?
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  expiryDate   DateTime?
  lastPurchase DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  purchaseItems PurchaseItem[] // back-relation
  // relation back-reference for wastage items
  wastageItems  WastageItem[]
}

model Supplier {
  id            String          @id @default(uuid())
  name          String
  category      String?
  contactPerson String?
  phone         String?
  email         String?
  address       String?
  gstNumber     String?
  creditDays    Int?
  rating        Float?
  status        String?
  totalOrders   Int?
  totalAmount   Float?
  lastOrderDate DateTime?
  createdAt     DateTime        @default(now())
  items         InventoryItem[]
  purchases     Purchase[]
  expenses      Expense[]
}

model Purchase {
  id            String    @id @default(uuid())
  supplierId    String?
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  invoiceNumber String?
  date          DateTime  @default(now())
  totalAmount   Float     @default(0)
  notes         String?
  createdAt     DateTime  @default(now())

  items PurchaseItem[]
}

model PurchaseItem {
  id              String         @id @default(uuid())
  purchaseId      String
  purchase        Purchase       @relation(fields: [purchaseId], references: [id])
  inventoryItemId String? // optional
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id]) // optional
  quantity        Float
  unitPrice       Float
  totalPrice      Float
}

model Recipe {
  id              String    @id @default(cuid())
  menuItemId      String?
  menuItem        MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  ingredients     Json      @default("[]")
  yield           Float     @default(1)
  cost            Float     @default(0)
  preparationTime Int?
  instructions    Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Expense {
  id              String   @id @default(cuid())
  title           String
  category        String
  subcategory     String?
  amount          Float
  netAmount       Float?
  taxAmount       Float?
  date            DateTime @default(now())
  vendor          String
  description     String?
  paymentMethod   String
  status          String
  receiptUrl      String?
  receiptNumber   String?
  recurring       Boolean @default(false)
  recurringPeriod String?
  approvedBy      String?
  supplierId      String?
  supplier        Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  tags            String[] @default([])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model BudgetCategory {
  id          String   @id @default(cuid())
  name        String
  budget      Float   @default(0)
  spent       Float   @default(0)
  icon        String?
  color       String?
  description String?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  color       String?
  type        String?    // e.g., 'menu', 'expense'
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  menuItems   MenuItem[]
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  permissions String[] @default([]) // <<< FIX: Changed from Json? to String[] for consistency
  dashboardModules String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  staff       Staff[]
}

model Wastage {
  id        String        @id @default(cuid())
  date      DateTime      @default(now())
  notes     String?
  createdBy String?
  items     WastageItem[]
}

model WastageItem {
  id              String        @id @default(cuid())
  wastage         Wastage       @relation(fields: [wastageId], references: [id])
  wastageId       String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  inventoryItemId String
  quantity        Float
  reason          String?
}

model ShiftLog {
  id          String   @id @default(uuid())
  staffId     String
  staff       Staff    @relation(fields: [staffId], references: [id])
  startTime   String
  endTime     String?
  openingCash Float
  closingCash Float?
  totalSales  Float?
  tips        Float?
  date        DateTime @default(now())
  status      String
  shiftType   String
}

model SalaryPayment {
  id          String   @id @default(uuid())
  staffId     String
  staff       Staff    @relation(fields: [staffId], references: [id])
  amount      Float
  paymentDate DateTime @default(now())
  paymentType String
  description String?
  paidBy      String?
  status      String
  month       String?
  year        Int?
}

model LoyaltyLog {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  points     Int
  action     String?
  date       DateTime @default(now())
}
