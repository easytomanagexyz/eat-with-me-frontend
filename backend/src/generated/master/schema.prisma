generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/master"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_MASTER")
}

enum PosType {
  RESTAURANT
  ARTIST
  BUSINESS
}

enum TenantStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum TenantPlanStatus {
  TRIAL
  ACTIVE
  IN_GRACE_PERIOD
  EXPIRED
  CANCELLED
}

enum TenantModuleStatus {
  ACTIVE
  DISABLED
  PENDING
}

enum AdminRole {
  SUPER
  SUPPORT
  VIEWER
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum UsageMetricType {
  REVENUE
  TRANSACTIONS
  ACTIVE_USERS
}

model Tenant {
  id                 String               @id @default(cuid())
  name               String
  email              String               @unique
  dbName             String               @unique
  dbUser             String
  dbPassword         String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  restaurantId       String               @unique
  useRedis           Boolean              @default(false)
  posType            PosType              @default(RESTAURANT)
  status             TenantStatus         @default(TRIAL)
  country            String?
  city               String?
  timezone           String?
  contactName        String?
  contactPhone       String?
  billingEmail       String?
  onboardingCompleted Boolean             @default(false)
  lastSeenAt         DateTime?
  notes              String?

  tenantPlans        TenantPlan[]
  modules            TenantModule[]
  usageSnapshots     TenantUsageSnapshot[]
}

model ServicePlan {
  id                   String          @id @default(cuid())
  name                 String
  code                 String          @unique
  posType              PosType
  description          String?
  featureHighlights    String[]        @default([])
  allowedModules       String[]        @default([])
  monthlyPriceCents    Int             @default(0)
  annualPriceCents     Int             @default(0)
  currency             String          @default("INR")
  defaultBillingCycle  BillingCycle    @default(MONTHLY)
  trialPeriodDays      Int             @default(14)
  isFeatured           Boolean         @default(false)
  isActive             Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  tenantPlans          TenantPlan[]
}

model TenantPlan {
  id                     String            @id @default(cuid())
  tenantId               String
  planId                 String
  status                 TenantPlanStatus  @default(TRIAL)
  billingCycle           BillingCycle      @default(MONTHLY)
  startDate              DateTime          @default(now())
  endDate                DateTime?
  renewalDate            DateTime?
  monthlyRevenueCents    Int               @default(0)
  totalRevenueCents      Int               @default(0)
  transactionsCount      Int               @default(0)
  lastActive             DateTime?
  allowedModulesSnapshot String[]         @default([])
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  tenant                 Tenant            @relation(fields: [tenantId], references: [id])
  plan                   ServicePlan       @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([planId])
}

model TenantModule {
  id         String             @id @default(cuid())
  tenantId   String
  moduleKey  String
  moduleName String?
  status     TenantModuleStatus @default(ACTIVE)
  assignedAt DateTime           @default(now())
  expiresAt  DateTime?
  lastUsedAt DateTime?

  tenant     Tenant             @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, moduleKey])
  @@index([tenantId])
}

model TenantUsageSnapshot {
  id          String            @id @default(cuid())
  tenantId    String
  snapshotDate DateTime
  metricType  UsageMetricType
  value       Int               @default(0)
  currency    String?
  metadata    Json?

  tenant      Tenant            @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, metricType, snapshotDate])
  @@index([tenantId, snapshotDate])
}

model AdminUser {
  id            String           @id @default(cuid())
  email         String           @unique
  passwordHash  String
  name          String?
  role          AdminRole        @default(SUPPORT)
  isActive      Boolean          @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  refreshTokens AdminRefreshToken[]
  auditLogs     AdminAuditLog[]
}

model AdminRefreshToken {
  id         String     @id @default(cuid())
  adminId    String
  token      String     @unique
  expiresAt  DateTime
  createdAt  DateTime   @default(now())
  revokedAt  DateTime?

  admin      AdminUser  @relation(fields: [adminId], references: [id])

  @@index([adminId])
}

model AdminAuditLog {
  id         String     @id @default(cuid())
  adminId    String?
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime   @default(now())

  admin      AdminUser? @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([createdAt])
}
